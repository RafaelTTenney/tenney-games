<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Profile | Games & Programs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --primary: #3366cc; --muted:#666; --bg:#f6f8fb; --card:#fff; }
    body { background: var(--bg); font-family: Roboto, Arial, sans-serif; margin:0; padding:0; }
    header { background: var(--primary); color:#fff; padding:12px 16px; text-align:center; font-weight:700; }
    .container { max-width:720px; margin: 28px auto; background: var(--card); border-radius:10px; padding:18px; box-shadow:0 8px 24px rgba(51,102,204,0.08); }
    h1 { color:var(--primary); margin:0 0 8px 0; }
    .meta { color:var(--muted); margin-bottom:12px; }
    .status { font-weight:700; color:#254a99; background:#e6f0ff; padding:8px 10px; border-radius:8px; display:inline-block; }
    ul { color:var(--muted); }
    .btn { background:var(--primary); color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:700; display:inline-block; margin-top:12px; }
    .btn.secondary { background:#fff; color:var(--primary); border:1px solid #99ccff; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #e6eefc; color:#254a99; }
    .score-muted { color: var(--muted); font-size: 0.95em; }
  </style>
</head>
<body>
  <header>Profile</header>
  <div class="container" id="profileContainer">
    <h1 id="profileName">Your Profile</h1>
    <div class="meta" id="profileEmail">Signed in as: <span id="profileUser">-</span></div>

    <div>
      <div>Account status: <span class="status" id="accountStatus">-</span></div>
      <div style="margin-top:12px;">
        <strong>What you can do with this account:</strong>
        <ul id="capabilitiesList"></ul>
      </div>

      <div style="margin-top:18px;">
        <h2 style="color:var(--primary); margin-bottom:6px;">Your High Scores</h2>
        <div class="score-muted" id="scoreStatus">Loading scores...</div>
        <table id="scoreTable" style="display:none;">
          <thead>
            <tr><th>Game</th><th>High Score</th><th>Updated</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <a id="upgradeBtn" class="btn" href="upgrade-request.html">Request an upgrade</a>
      <a id="backBtn" class="btn secondary" href="loggedIn.html" style="margin-left:12px;">Back to Dashboard</a>
    </div>
  </div>

  <footer style="text-align:center;padding:12px;color:#999;">&copy; 2025 Games & Programs | Contact: <a href="questions-dashboard.html">Questions & Comments</a></footer>

  <script type="module" src="login.js?v=7"></script>
  <script type="module">
    import { auth, db, hasFirebaseConfig } from './firebase.js';
    import { collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    function formatTimestamp(ts) {
      if (!ts) return '-';
      const date = ts.toDate ? ts.toDate() : new Date(ts);
      return date.toLocaleString();
    }

    async function loadScores(user) {
      const statusEl = document.getElementById('scoreStatus');
      const table = document.getElementById('scoreTable');
      const tbody = document.querySelector('#scoreTable tbody');
      if (!hasFirebaseConfig()) {
        statusEl.textContent = 'Firebase is not configured.';
        return;
      }
      if (!user) {
        statusEl.textContent = 'Log in to see your scores.';
        return;
      }
      const snap = await getDocs(query(
        collection(db, 'highScores'),
        where('uid', '==', user.uid)
      ));
      const scores = snap.docs.map(doc => doc.data());
      scores.sort((a, b) => (b.score || 0) - (a.score || 0));
      if (!scores.length) {
        statusEl.textContent = 'No scores yet. Play a game to set one!';
        return;
      }
      tbody.innerHTML = scores.map(score => `
        <tr>
          <td>${score.gameId || '-'}</td>
          <td>${score.score ?? '-'}</td>
          <td>${formatTimestamp(score.updatedAt)}</td>
        </tr>
      `).join('');
      statusEl.textContent = '';
      table.style.display = '';
    }

    document.addEventListener('DOMContentLoaded', async function() {
      if (window.whenAuthReady) await window.whenAuthReady;
      if (!window.enforcePageAccess('profile.html')) return;

      const profile = window.getProfile ? window.getProfile() : {};
      document.getElementById('profileUser').textContent = profile.username || profile.email || 'Unknown';
      document.getElementById('profileName').textContent = profile.first_name || profile.firstName || 'Unknown';
      const status = window.getAccountStatus ? window.getAccountStatus() : 'standard';
      document.getElementById('accountStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);

      const capabilities = {
        'standard': [
          'Access dashboard (loggedIn.html)',
          'Use Menu Guessers (menu-guesser.html)',
          'Play games (multi-game.html)'
        ],
        'advance': [
          'Everything a standard user can do',
          'Preview in-development games (preview-games.html)',
          'Play previews and submit bug reports & suggestions'
        ],
        'admin': [
          'Full access to the site',
          'Access experimental uploads (experimental.html)',
          'Access admin dashboard (admin.html) to monitor & manage accounts'
        ]
      };

      const list = document.getElementById('capabilitiesList');
      list.innerHTML = (capabilities[status] || capabilities.standard).map(s => `<li>${s}</li>`).join('');
      await loadScores(auth.currentUser);
    });
  </script>
</body>
</html>
